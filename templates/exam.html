{% extends "base.html" %}

{% block title %}الامتحان التنافسي - بنك طب نساء{% endblock %}

{% block content %}
<main id="mainContent" role="main" tabindex="-1">
    <!-- Multiplayer Lobby -->
    <section id="multiplayerLobby" class="mb-4">
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body">
                <div id="lobbyStepCreateJoin" class="p-4 bg-light rounded-4 mb-4">
                    <div class="text-center mb-4">
                        <h4 class="fw-bold mb-1"><i class="fas fa-users me-2 text-primary"></i>بنك طب نساء</h4>
                        <p class="text-muted mb-0">يمكنك إنشاء غرفة جديدة أو الانضمام إلى غرفة موجودة باستخدام رمز
                            الغرفة.</p>
                    </div>
                    <form class="row g-3 align-items-end justify-content-center" autocomplete="off"
                        onsubmit="return false;">
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="playerName"><i
                                    class="fas fa-user me-1"></i>اسمك</label>
                            <input type="text" id="playerName" class="form-control form-control-lg rounded-pill"
                                placeholder="أدخل اسمك" aria-label="اسمك" required>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label fw-semibold" for="questionListSelect"><i
                                    class="fas fa-list me-1"></i>اختر قائمة الأسئلة</label>
                            <select id="questionListSelect" class="form-select form-select-lg rounded-pill"
                                aria-label="اختر قائمة الأسئلة"></select>
                        </div>
                        <div class="col-12 col-md-4 d-grid">
                            <button type="button" class="btn btn-primary btn-lg rounded-pill mb-2 mb-md-0 w-100"
                                id="createRoomBtn">
                                <i class="fas fa-plus me-1"></i> إنشاء غرفة جديدة
                            </button>
                        </div>
                    </form>
                    <form class="row g-3 align-items-end justify-content-center mt-2" autocomplete="off"
                        onsubmit="return false;">
                        <div class="col-6 col-md-2">
                            <label class="form-label fw-semibold" for="joinRoomCode"><i class="fas fa-key me-1"></i>رمز
                                الغرفة</label>
                            <input type="text" id="joinRoomCode"
                                class="form-control form-control-lg rounded-pill text-center" maxlength="6"
                                placeholder="رمز الغرفة" aria-label="رمز الغرفة" required>
                        </div>
                        <div class="col-6 col-md-2 d-grid">
                            <button type="button" class="btn btn-success btn-lg rounded-pill w-100" id="joinRoomBtn">
                                <i class="fas fa-sign-in-alt me-1"></i> انضمام
                            </button>
                        </div>
                    </form>
                </div>
                <div id="lobbyStepRoom" style="display:none;">
                    <div class="row g-2 align-items-center mb-2">
                        <div class="col-12 col-md-auto mb-2 mb-md-0">
                            <span class="fw-bold">رمز الغرفة:</span>
                            <span id="roomCodeDisplay" class="badge bg-primary fs-5"></span>
                            <button class="btn btn-outline-secondary btn-sm ms-2" id="copyRoomCodeBtn"
                                aria-label="نسخ رمز الغرفة"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-12">
                            <span class="fw-bold">اللاعبون في الغرفة:</span>
                            <ul id="playersList" class="list-group list-group-flush mb-2"></ul>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-12 d-grid">
                            <div id="hostControls" style="display:none;">
                                <button class="btn btn-warning w-100" id="startGameBtn"><i class="fas fa-play"></i> بدء
                                    الامتحان</button>
                            </div>
                            <div class="alert alert-info mt-2" id="waitingMsg">بانتظار بدء الامتحان من قبل المضيف...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Leaderboard -->
    <section id="leaderboardSection" class="mb-3" style="display:none;">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header py-2 px-3 text-white bg-gradient"
                style="background: var(--primary, #3a47d5); border-radius: 12px 12px 0 0; min-height: 36px;">
                <span class="fw-bold" style="font-size: 1rem;"><i class="fas fa-trophy me-2"></i>المتصدرون</span>
            </div>
            <div class="card-body p-2">
                <div class="table-responsive" style="max-height: 120px; overflow-y: auto;">
                    <table class="table table-borderless table-sm text-center mb-0 align-middle"
                        style="font-size: 0.95rem;">
                        <thead style="background: #f4f6fa;">
                            <tr style="font-weight: 600;">
                                <th style="color: var(--primary, #3a47d5);">#</th>
                                <th style="color: var(--primary, #3a47d5);">الاسم</th>
                                <th style="color: var(--primary, #3a47d5);">النتيجة</th>
                                <th style="color: var(--primary, #3a47d5);">الزمن</th>
                                <th style="color: var(--primary, #3a47d5);">التقدم</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Exam Container -->
    <section id="examContainer" class="exam-container" style="display:none;">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card rounded-4 shadow-sm" style="display:none;">
                    <!-- Sticky Progress Bar -->
                    <div class="card-header bg-primary text-white sticky-top" style="z-index: 1020;"
                        style="height:0px;">
                        <div class="progress-bar bg-light" id="progressBar" role="progressbar"
                            style="width: 1%; display: none;">
                        </div>
                    </div>
                    <div class="card-header bg-primary text-white">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fas fa-question-circle me-2"></i>
                                    السؤال <span id="questionNumber">1</span>
                                </h5>
                            </div>
                            <div class="col-auto d-flex gap-2">
                                <button class="question-list-btn" onclick="showQuestionList()" title="قائمة الأسئلة"
                                    aria-label="قائمة الأسئلة">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4" style="background-color: #f4f6fa; border-radius: 15px;">
                    <div id="questionsContainer" dir="ltr" style="text-align: left;"></div>
                </div>
            </div>
        </div>

        <!-- Fixed Bottom Navigation -->
        <div class="fixed-bottom-nav">
            <div class="nav-btn-group">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" aria-label="السابق">
                    <i class="fas fa-arrow-right me-2"></i>
                </button>
                <div class="question-counter" onclick="showQuestionList()" style="cursor: pointer;"
                    title="عرض قائمة الأسئلة">
                    <span id="questionCounterNumber">1</span> / <span id="questionCounterTotal">1</span>
                </div>
                <div class="next-finish-wrapper">
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display: none;">
                        <i class="fas fa-arrow-left me-2"></i> التالي
                    </button>
                    <button class="btn btn-success" id="finishBtn" onclick="finishExam()" style="display: none;">
                        <i class="fas fa-check me-2"></i> إنهاء الامتحان
                    </button>
                </div>
            </div>
            <div class="exam-footer">
                Made with ❤️ by Raafat Sami
            </div>
        </div>

        <!-- Question List Modal -->
        <div class="modal fade" id="questionListModal" tabindex="-1" aria-modal="true"
            aria-labelledby="questionListModalLabel">
            <div class="modal-dialog modal-lg">
                <div class="modal-content rounded-4">
                    <div class="modal-header">
                        <h5 class="modal-title" id="questionListModalLabel">قائمة الأسئلة</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row" id="questionList"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Results Modal -->
        <div class="modal fade" id="resultsModal" tabindex="-1" aria-modal="true" aria-labelledby="resultsModalLabel">
            <div class="modal-dialog modal-xl">
                <div class="modal-content rounded-4">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="resultsModalLabel"><i class="fas fa-trophy me-2"></i>نتيجة الامتحان
                        </h5>
                    </div>
                    <div class="modal-body text-center">
                        <div class="score-display mb-4" id="finalScore" aria-live="polite">0%</div>
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light rounded-3">
                                    <div class="card-body">
                                        <h5 class="text-success"><i class="fas fa-check-circle me-2"></i>الإجابات
                                            الصحيحة</h5>
                                        <h2 class="text-success" id="correctCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light rounded-3">
                                    <div class="card-body">
                                        <h5 class="text-danger"><i class="fas fa-times-circle me-2"></i>الإجابات الخاطئة
                                        </h5>
                                        <h2 class="text-danger" id="incorrectCount">0</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="progress mb-4" style="height: 20px;">
                            <div class="progress-bar bg-success" id="finalProgressBar" role="progressbar"
                                style="width: 0%"></div>
                        </div>
                        <div class="alert alert-info" id="performanceMessage" aria-live="polite"></div>
                        <!-- Review Section -->
                        <div id="reviewSection" style="display: none;">
                            <div class="review-section" onclick="toggleReview()" tabindex="0" role="button"
                                aria-expanded="false">
                                <h5 class="mb-2"><i class="fas fa-eye me-2"></i>مراجعة الإجابات الخاطئة</h5>
                                <p class="mb-0">اضغط هنا لمراجعة الأسئلة التي أجبت عليها خطأ</p>
                            </div>
                            <div id="reviewContent" style="display: none;">
                                <div class="text-start">
                                    <h6 class="mb-3 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>الأسئلة
                                        الخاطئة:</h6>
                                    <div id="reviewQuestions"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer flex-column flex-sm-row">
                        <a href="{{ url_for('restart') }}" class="btn btn-primary mb-2 mb-sm-0"><i
                                class="fas fa-redo me-2"></i>إعادة الامتحان</a>
                        <button type="button" class="btn btn-secondary" onclick="closeResultsModal()"><i
                                class="fas fa-times me-2"></i>إغلاق</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Sound effect audio elements using Mixkit URLs -->
    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2870/2870-preview.mp3"
        preload="auto"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/950/950-preview.mp3"
        preload="auto"></audio>
    <audio id="sound-toggle" src="https://assets.mixkit.co/active_storage/sfx/2579/2579-preview.mp3"
        preload="auto"></audio>

    <!-- Floating buttons -->
    <button id="muteBtn" class="floating-btn" aria-label="تبديل الصوت" title="تبديل الصوت">
        <i class="fas fa-volume-up"></i>
    </button>
    <button id="randomizeToggle" class="floating-btn" title="ترتيب عشوائي للأسئلة" aria-label="ترتيب عشوائي للأسئلة">
        <i class="fas fa-random"></i>
    </button>
</main>
{% endblock %}

{% block scripts %}
<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<!-- Pass server data to JavaScript -->
<script type="application/json" id="serverData">
{
    "questions": {{ questions | tojson | safe }},
    "totalQuestions": {{ total_questions }},
    "randomizeQuestions": {{ 'true' if randomize_questions else 'false' }}
}
</script>

<script>
    // Multiplayer variables
    let socket = io();
    let roomCode = localStorage.getItem('room_code') || null;
    let isHost = false;
    let playerName = '';
    let gameStarted = false;
    let multiplayerMode = true; // Always multiplayer for this version
    let resultsShown = false; // Flag to track if results have been shown

    // Hide exam UI until game starts
    const examContainer = document.getElementById('examContainer');
    const leaderboardSection = document.getElementById('leaderboardSection');
    const lobbyStepCreateJoin = document.getElementById('lobbyStepCreateJoin');
    const lobbyStepRoom = document.getElementById('lobbyStepRoom');
    const hostControls = document.getElementById('hostControls');
    const waitingMsg = document.getElementById('waitingMsg');

    // Persistent client_id for each browser
    function getClientId() {
        let cid = localStorage.getItem('client_id');
        if (!cid) {
            cid = self.crypto?.randomUUID ? self.crypto.randomUUID() : ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
            localStorage.setItem('client_id', cid);
        }
        return cid;
    }
    const clientId = getClientId();

    // Lobby event listeners
    if (document.getElementById('createRoomBtn')) {
        document.getElementById('createRoomBtn').onclick = function () {
            playerName = document.getElementById('playerName').value.trim() || 'مجهول';
            const questionList = document.getElementById('questionListSelect').value || 'list1';
            socket.emit('create_room', { name: playerName, client_id: clientId, question_list: questionList });
        };
    }
    if (document.getElementById('joinRoomBtn')) {
        document.getElementById('joinRoomBtn').onclick = function () {
            playerName = document.getElementById('playerName').value.trim() || 'مجهول';
            const code = document.getElementById('joinRoomCode').value.trim().toUpperCase();
            if (code.length === 6) {
                roomCode = code;
                localStorage.setItem('room_code', roomCode);
                socket.emit('join_room', { name: playerName, room_code: code, client_id: clientId });
            }
        };
    }
    if (document.getElementById('copyRoomCodeBtn')) {
        document.getElementById('copyRoomCodeBtn').onclick = function () {
            navigator.clipboard.writeText(roomCode);
        };
    }

    // Socket.IO events
    socket.on('room_created', function (data) {
        roomCode = data.room_code;
        localStorage.setItem('room_code', roomCode);
        isHost = true;
        showRoomLobby(data.players, data.question_list, data.total_questions);
    });
    socket.on('player_joined', function (data) {
        showRoomLobby(data.players, data.question_list, data.total_questions);
        // Show leaderboard immediately with all participants
        updateLeaderboard(Object.values(data.players).map(p => ({
            name: p.name,
            score: p.score || 0,
            time: p.time || 0,
            finished: p.finished || false,
            progress: p.progress || 0
        })));
    });
    socket.on('player_left', function (data) {
        showRoomLobby(data.players, data.question_list, data.total_questions);
        // Update leaderboard when players leave
        updateLeaderboard(Object.values(data.players).map(p => ({
            name: p.name,
            score: p.score || 0,
            time: p.time || 0,
            finished: p.finished || false,
            progress: p.progress || 0
        })));
    });
    socket.on('game_started', function (data) {
        gameStarted = true;
        questions = data.questions;
        totalQuestions = data.total_questions;
        resultsShown = false; // Reset results shown flag for new game
        document.getElementById('multiplayerLobby').style.display = 'none';
        examContainer.style.display = 'block';
        leaderboardSection.style.display = 'block';
        // Reset answers and question index for each user
        userAnswers = {};
        currentQuestionIndex = 0;
        loadQuestions();
        showQuestion(0);
        updateProgress();
        generateQuestionList();
        updateNavigationButtons();
        updateLeaderboard([]);

        // Set total questions display
        document.getElementById('questionCounterTotal').textContent = totalQuestions;
    });
    socket.on('leaderboard_update', function (data) {
        updateLeaderboard(data.leaderboard);
        if (data.total_questions) totalQuestions = data.total_questions;
        // If this player finished and results haven't been shown yet, show results modal
        const me = data.leaderboard.find(p => p.name === playerName);
        if (me && me.finished && !resultsShown) {
            resultsShown = true; // Mark results as shown
            showResults({
                correct_answers: me.score,
                total_questions: totalQuestions,
                score_percentage: (me.score / totalQuestions) * 100
            });
        }
    });
    socket.on('error', function (data) {
        alert(data.message);
    });

    function showRoomLobby(players, questionList, totalQuestions) {
        lobbyStepCreateJoin.style.display = 'none';
        lobbyStepRoom.style.display = 'block';
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        // Show selected list
        let listLabel = document.getElementById('selectedListLabel');
        if (!listLabel) {
            listLabel = document.createElement('div');
            listLabel.id = 'selectedListLabel';
            listLabel.className = 'mt-2 mb-2';
            document.getElementById('lobbyStepRoom').prepend(listLabel);
        }
        listLabel.innerHTML = `<span class="fw-bold">قائمة الأسئلة المختارة:</span> <span class="badge bg-info">${questionList === 'list1' ? 'اخر 50 سؤال' : questionList === 'list2' ? 'اول 99' : questionList}</span> <span class="fw-bold ms-2">عدد الأسئلة:</span> <span class="badge bg-secondary">${totalQuestions}</span>`;
        // List players
        const playersList = document.getElementById('playersList');
        playersList.innerHTML = '';
        let i = 1;
        for (const [sid, player] of Object.entries(players)) {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<span class="fw-bold">${i++}.</span> ${player.name}`;
            playersList.appendChild(li);
        }
        // Host controls
        if (isHost) {
            hostControls.style.display = 'block';
            waitingMsg.style.display = 'none';
        } else {
            hostControls.style.display = 'none';
            waitingMsg.style.display = 'block';
        }
        // Show leaderboard immediately with all participants
        updateLeaderboard(Object.values(players).map(p => ({
            name: p.name,
            score: p.score || 0,
            time: p.time || 0,
            finished: p.finished || false,
            progress: p.progress || 0
        })));
    }
    if (document.getElementById('startGameBtn')) {
        document.getElementById('startGameBtn').onclick = function () {
            socket.emit('start_game', { room_code: roomCode, client_id: clientId });
        };
    }

    function updateLeaderboard(leaderboard) {
        const tbody = document.getElementById('leaderboardBody');
        tbody.innerHTML = '';
        leaderboard.forEach((player, idx) => {
            const progressPercent = Math.round((player.progress || 0) / totalQuestions * 100);
            const isMe = player.name === playerName;
            const rowClass = isMe ? 'table-primary fw-bold' : '';
            const tr = document.createElement('tr');
            tr.className = rowClass;
            const progressBar = `<div class='progress leaderboard-progress-bar' style='height:16px; min-width:80px;'>
                <div class='progress-bar ${player.finished ? 'bg-success' : ''}' role='progressbar' style='width:${progressPercent}%; transition: width 0.5s;'>
                    <span style='color:#fff; font-size:0.9em;'>${progressPercent}%</span>
                </div>
            </div>`;
            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td>${player.name} ${isMe ? '<i class=\'fas fa-user\'></i>' : ''}</td>
                <td>${player.score || 0}</td>
                <td>${player.finished ? (player.time || 0).toFixed(1) : '-'}</td>
                <td>${player.finished ? '<span class=\'badge bg-success\'>انتهى</span>' : progressBar}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Exam logic integration
    function finishExam() {
        // Submit exam to server via Socket.IO
        const codeToSend = roomCode || localStorage.getItem('room_code');
        socket.emit('submit_answers', { room_code: codeToSend, answers: userAnswers, client_id: clientId });
    }

    // Hide exam UI until multiplayer game starts
    examContainer.style.display = 'none';
    leaderboardSection.style.display = 'none';

    // Global variables
    let currentQuestionIndex = 0;
    let questions = [];
    let userAnswers = {};
    let totalQuestions = 0;
    let incorrectAnswers = [];
    let randomizeQuestions = true;

    // Initialize the exam
    document.addEventListener('DOMContentLoaded', function () {
        // Load server data
        try {
            const serverData = JSON.parse(document.getElementById('serverData').textContent);
            questions = serverData.questions;
            totalQuestions = serverData.totalQuestions;
            randomizeQuestions = serverData.randomizeQuestions;
        } catch (e) {
            console.error('Error loading server data:', e);
        }

        loadQuestions();
        showQuestion(0);
        updateProgress();
        generateQuestionList();
        updateNavigationButtons();
        setupRandomizationControls();
        updateRandomizationStatus();

        // Set total questions display
        document.getElementById('questionCounterTotal').textContent = totalQuestions;

        // Prevent zoom on double tap for mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Fetch available question lists and populate the select
        fetch('/get_question_lists').then(r => r.json()).then(lists => {
            const select = document.getElementById('questionListSelect');
            select.innerHTML = '';
            Object.entries(lists).forEach(([key, count]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${key === 'list1' ? 'اخر 50 سؤال' : key === 'list2' ? 'اول 99 سؤال' : key} (${count} سؤال)`;
                select.appendChild(option);
            });
        });
    });

    function setupRandomizationControls() {
        const randomizeToggle = document.getElementById('randomizeToggle');

        randomizeToggle.addEventListener('click', function () {
            randomizeQuestions = !randomizeQuestions;
            updateRandomizationSettings();
            updateRandomizationStatus();
        });
    }

    function updateRandomizationStatus() {
        const randomizeToggle = document.getElementById('randomizeToggle');
        if (randomizeQuestions) {
            randomizeToggle.classList.add('active');
            randomizeToggle.classList.remove('inactive');
        } else {
            randomizeToggle.classList.add('inactive');
            randomizeToggle.classList.remove('active');
        }
    }

    function updateRandomizationSettings() {
        let url = '/update_randomization';
        if (multiplayerMode && roomCode) {
            url += `?room_code=${encodeURIComponent(roomCode)}`;
        }
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                randomize_questions: randomizeQuestions
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    showRandomizationFeedback();

                    // Reload questions with new settings
                    reloadQuestionsWithNewSettings();
                }
            })
            .catch(error => {
                console.error('Error updating randomization settings:', error);
            });
    }

    function reloadQuestionsWithNewSettings() {
        // Store current question index and answers
        const currentIndex = currentQuestionIndex;
        const savedAnswers = { ...userAnswers };

        // Get updated questions data from server
        let url = '/get_questions_data';
        if (multiplayerMode && roomCode) {
            url += `?room_code=${encodeURIComponent(roomCode)}`;
        }
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }

                // Update global variables
                questions = data.questions;
                totalQuestions = data.total_questions;
                randomizeQuestions = data.randomize_questions;

                // Reload questions in the container
                loadQuestions();

                // Restore current question and answers
                currentQuestionIndex = currentIndex;
                userAnswers = savedAnswers;

                // Show the current question with restored state
                showQuestion(currentIndex);

                // Update question list
                generateQuestionList();

                // Update progress
                updateProgress();

                // Show success message
                showRandomizationFeedback();
            })
            .catch(error => {
                console.error('Error reloading questions:', error);
                // Fallback: reload the page
                window.location.reload();
            });
    }

    function showRandomizationFeedback() {
        // Create a temporary success message
        const feedback = document.createElement('div');
        feedback.className = 'alert alert-success alert-dismissible fade show position-fixed';
        feedback.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        feedback.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        تم تحديث إعدادات الامتحان بنجاح
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(feedback);

        // Remove after 3 seconds
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 3000);
    }

    function loadQuestions() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-slide';
            questionDiv.style.display = index === 0 ? 'block' : 'none';
            questionDiv.innerHTML = `
        <div class="question-text">
            ${question.text}
        </div>
        
        <div class="options-container">
            ${question.options.map((option, optionIndex) => `
                <div class="option-item" data-question="${index}" data-option="${optionIndex}" data-correct="${question.correct_answer}">
                    <div class="form-check w-100">
                        <input class="form-check-input" type="radio" 
                               name="answer_${index}" id="option_${index}_${optionIndex}" 
                               value="${optionIndex}">
                        <label class="form-check-label" for="option_${index}_${optionIndex}">
                            ${option}
                        </label>
                    </div>
                </div>
            `).join('')}
        </div>
    `