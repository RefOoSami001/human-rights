{% extends "base.html" %}

{% block title %}الامتحان التنافسي - بنك طب نساء{% endblock %}

{% block content %}
<div id="multiplayerLobby" class="mb-4">
    <div class="card">
        <div class="card-body">
            <div id="lobbyStepCreateJoin" class="p-4 bg-light rounded mb-4">
                <div class="text-center mb-4">
                    <h4 class="fw-bold mb-1"><i class="fas fa-users me-2 text-primary"></i>بنك طب نساء
                    </h4>
                    <br><br>
                    <p class="text-muted mb-0">يمكنك إنشاء غرفة جديدة أو الانضمام إلى غرفة موجودة باستخدام رمز الغرفة.
                    </p>
                </div>
                <div class="row g-3 align-items-end justify-content-center">
                    <div class="col-12 col-md-4">
                        <label class="form-label fw-semibold"><i class="fas fa-user me-1"></i>اسمك</label>
                        <input type="text" id="playerName" class="form-control form-control-lg rounded-pill"
                            placeholder="أدخل اسمك" autocomplete="off">
                    </div>
                    <div class="col-12 col-md-4 d-grid">
                        <button class="btn btn-primary btn-lg rounded-pill mb-2 mb-md-0 w-100" id="createRoomBtn">
                            <i class="fas fa-plus me-1"></i> إنشاء غرفة جديدة
                        </button>
                    </div>
                </div>
                <div class="row g-3 align-items-end justify-content-center mt-2">
                    <div class="col-6 col-md-2">
                        <label class="form-label fw-semibold"><i class="fas fa-key me-1"></i>رمز الغرفة</label>
                        <input type="text" id="joinRoomCode"
                            class="form-control form-control-lg rounded-pill text-center" maxlength="6"
                            placeholder="رمز الغرفة">
                    </div>
                    <div class="col-6 col-md-2 d-grid">
                        <button class="btn btn-success btn-lg rounded-pill w-100" id="joinRoomBtn">
                            <i class="fas fa-sign-in-alt me-1"></i> انضمام
                        </button>
                    </div>
                </div>
            </div>
            <div id="lobbyStepRoom" style="display:none;">
                <div class="row g-2 align-items-center mb-2">
                    <div class="col-12 col-md-auto mb-2 mb-md-0">
                        <span class="fw-bold">رمز الغرفة:</span>
                        <span id="roomCodeDisplay" class="badge bg-primary fs-5"></span>
                        <button class="btn btn-outline-secondary btn-sm ms-2" id="copyRoomCodeBtn"><i
                                class="fas fa-copy"></i></button>
                    </div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-12">
                        <span class="fw-bold">اللاعبون في الغرفة:</span>
                        <ul id="playersList" class="list-group list-group-flush mb-2"></ul>
                    </div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-12 d-grid">
                        <div id="hostControls" style="display:none;">
                            <button class="btn btn-warning w-100" id="startGameBtn"><i class="fas fa-play"></i> بدء
                                الامتحان</button>
                        </div>
                        <div class="alert alert-info mt-2" id="waitingMsg">بانتظار بدء الامتحان من قبل المضيف...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaderboard -->
<div id="leaderboardSection" class="mb-3" style="display:none;">
    <div class="card border-0 shadow-sm" style="background: #fff; border-radius: 12px;">
        <div class="card-header py-2 px-3 text-white"
            style="background: #3a47d5; border-radius: 12px 12px 0 0; min-height: 36px;">
            <span class="fw-bold" style="font-size: 1rem;"><i class="fas fa-trophy me-2"></i>المتصدرون</span>
        </div>
        <div class="card-body p-2">
            <div class="table-responsive" style="max-height: 120px; overflow-y: auto;">
                <table class="table table-borderless table-sm text-center mb-0 align-middle"
                    style="font-size: 0.95rem;">
                    <thead style="background: #f4f6fa;">
                        <tr style="font-weight: 600;">
                            <th style="color: #3a47d5;">#</th>
                            <th style="color: #3a47d5;">الاسم</th>
                            <th style="color: #3a47d5;">النتيجة</th>
                            <th style="color: #3a47d5;">الزمن</th>
                            <th style="color: #3a47d5;">الحالة</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="examContainer" style="display:none;">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Question Container -->
            <div class="card">
                <!-- Progress Bar -->
                <div class="card-header bg-primary text-white">
                    <div class="progress" style="height: 8px; background-color: rgba(255,255,255,0.2);">
                        <div class="progress-bar bg-light" id="progressBar" role="progressbar" style="width: 1%">
                        </div>
                    </div>
                </div>

                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-0">
                                <i class="fas fa-question-circle me-2"></i>
                                السؤال <span id="questionNumber">1</span> من {{ total_questions }}
                            </h5>
                        </div>
                        <div class="col-auto d-flex gap-2">
                            <button class="toggle-btn" id="randomizeToggle" title="ترتيب عشوائي للأسئلة">
                                <i class="fas fa-random"></i>
                            </button>
                            <button class="toggle-btn" onclick="showQuestionList()" title="قائمة الأسئلة">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body p-4">
                    <!-- Questions will be loaded here -->
                    <div id="questionsContainer" dir="ltr" style="text-align: left;">
                        <!-- Questions will be dynamically inserted here -->
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <button class="btn btn-secondary flex-fill me-2" id="prevBtn" onclick="previousQuestion()">
                            <i class="fas fa-arrow-right me-2"></i>
                            السابق
                        </button>

                        <div class="d-flex gap-2 flex-fill">
                            <button class="btn btn-primary flex-fill" id="nextBtn" onclick="nextQuestion()"
                                style="display: none;">
                                <i class="fas fa-arrow-left me-2"></i>
                                التالي
                            </button>

                            <button class="btn btn-success flex-fill" id="finishBtn" onclick="finishExam()"
                                style="display: none;">
                                <i class="fas fa-check me-2"></i>
                                إنهاء الامتحان
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question List Modal -->
    <div class="modal fade" id="questionListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">قائمة الأسئلة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="questionList">
                        <!-- Question list will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-trophy me-2"></i>
                        نتيجة الامتحان
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="score-display mb-4" id="finalScore">0%</div>

                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="text-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        الإجابات الصحيحة
                                    </h5>
                                    <h2 class="text-success" id="correctCount">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="text-danger">
                                        <i class="fas fa-times-circle me-2"></i>
                                        الإجابات الخاطئة
                                    </h5>
                                    <h2 class="text-danger" id="incorrectCount">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="progress mb-4" style="height: 20px;">
                        <div class="progress-bar bg-success" id="finalProgressBar" role="progressbar" style="width: 0%">
                        </div>
                    </div>

                    <div class="alert alert-info" id="performanceMessage">
                        <!-- Performance message will be inserted here -->
                    </div>

                    <!-- Review Section -->
                    <div id="reviewSection" style="display: none;">
                        <div class="review-section" onclick="toggleReview()">
                            <h5 class="mb-2">
                                <i class="fas fa-eye me-2"></i>
                                مراجعة الإجابات الخاطئة
                            </h5>
                            <p class="mb-0">اضغط هنا لمراجعة الأسئلة التي أجبت عليها خطأ</p>
                        </div>

                        <div id="reviewContent" style="display: none;">
                            <div class="text-start">
                                <h6 class="mb-3 text-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    الأسئلة الخاطئة:
                                </h6>
                                <div id="reviewQuestions">
                                    <!-- Review questions will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex-column flex-sm-row">
                    <a href="{{ url_for('restart') }}" class="btn btn-primary mb-2 mb-sm-0">
                        <i class="fas fa-redo me-2"></i>
                        إعادة الامتحان
                    </a>
                    <button type="button" class="btn btn-secondary" onclick="closeResultsModal()">
                        <i class="fas fa-times me-2"></i>
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<!-- Pass server data to JavaScript -->
<script type="application/json" id="serverData">
{
    "questions": {{ questions | tojson | safe }},
    "totalQuestions": {{ total_questions }},
    "randomizeQuestions": {{ 'true' if randomize_questions else 'false' }}
}
</script>

<script>
    // Multiplayer variables
    let socket = io();
    let roomCode = localStorage.getItem('room_code') || null;
    let isHost = false;
    let playerName = '';
    let gameStarted = false;
    let multiplayerMode = true; // Always multiplayer for this version

    // Hide exam UI until game starts
    const examContainer = document.getElementById('examContainer');
    const leaderboardSection = document.getElementById('leaderboardSection');
    const lobbyStepCreateJoin = document.getElementById('lobbyStepCreateJoin');
    const lobbyStepRoom = document.getElementById('lobbyStepRoom');
    const hostControls = document.getElementById('hostControls');
    const waitingMsg = document.getElementById('waitingMsg');

    // Persistent client_id for each browser
    function getClientId() {
        let cid = localStorage.getItem('client_id');
        if (!cid) {
            cid = self.crypto?.randomUUID ? self.crypto.randomUUID() : ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
            localStorage.setItem('client_id', cid);
        }
        return cid;
    }
    const clientId = getClientId();

    // Lobby event listeners
    if (document.getElementById('createRoomBtn')) {
        document.getElementById('createRoomBtn').onclick = function () {
            playerName = document.getElementById('playerName').value.trim() || 'مجهول';
            socket.emit('create_room', { name: playerName, client_id: clientId });
        };
    }
    if (document.getElementById('joinRoomBtn')) {
        document.getElementById('joinRoomBtn').onclick = function () {
            playerName = document.getElementById('playerName').value.trim() || 'مجهول';
            const code = document.getElementById('joinRoomCode').value.trim().toUpperCase();
            if (code.length === 6) {
                roomCode = code;
                localStorage.setItem('room_code', roomCode);
                socket.emit('join_room', { name: playerName, room_code: code, client_id: clientId });
            }
        };
    }
    if (document.getElementById('copyRoomCodeBtn')) {
        document.getElementById('copyRoomCodeBtn').onclick = function () {
            navigator.clipboard.writeText(roomCode);
        };
    }

    // Socket.IO events
    socket.on('room_created', function (data) {
        roomCode = data.room_code;
        localStorage.setItem('room_code', roomCode);
        isHost = true;
        showRoomLobby(data.players);
    });
    socket.on('player_joined', function (data) {
        showRoomLobby(data.players);
        // Show leaderboard immediately with all participants
        updateLeaderboard(Object.values(data.players).map(p => ({
            name: p.name,
            score: p.score || 0,
            time: p.time || 0,
            finished: p.finished || false,
            progress: p.progress || 0
        })));
    });
    socket.on('player_left', function (data) {
        showRoomLobby(data.players);
        // Update leaderboard when players leave
        updateLeaderboard(Object.values(data.players).map(p => ({
            name: p.name,
            score: p.score || 0,
            time: p.time || 0,
            finished: p.finished || false,
            progress: p.progress || 0
        })));
    });
    socket.on('game_started', function (data) {
        gameStarted = true;
        questions = data.questions;
        totalQuestions = questions.length;
        document.getElementById('multiplayerLobby').style.display = 'none';
        examContainer.style.display = 'block';
        leaderboardSection.style.display = 'block';
        // Reset answers and question index for each user
        userAnswers = {};
        currentQuestionIndex = 0;
        loadQuestions();
        showQuestion(0);
        updateProgress();
        generateQuestionList();
        updateNavigationButtons();
        updateLeaderboard([]);
    });
    socket.on('leaderboard_update', function (data) {
        updateLeaderboard(data.leaderboard);
    });
    socket.on('error', function (data) {
        alert(data.message);
    });

    function showRoomLobby(players) {
        lobbyStepCreateJoin.style.display = 'none';
        lobbyStepRoom.style.display = 'block';
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        // List players
        const playersList = document.getElementById('playersList');
        playersList.innerHTML = '';
        let i = 1;
        for (const [sid, player] of Object.entries(players)) {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<span class="fw-bold">${i++}.</span> ${player.name}`;
            playersList.appendChild(li);
        }
        // Host controls
        if (isHost) {
            hostControls.style.display = 'block';
            waitingMsg.style.display = 'none';
        } else {
            hostControls.style.display = 'none';
            waitingMsg.style.display = 'block';
        }
        // Show leaderboard immediately with all participants
        updateLeaderboard(Object.values(players).map(p => ({
            name: p.name,
            score: p.score || 0,
            time: p.time || 0,
            finished: p.finished || false,
            progress: p.progress || 0
        })));
    }
    if (document.getElementById('startGameBtn')) {
        document.getElementById('startGameBtn').onclick = function () {
            socket.emit('start_game', { room_code: roomCode, client_id: clientId });
        };
    }

    function updateLeaderboard(leaderboard) {
        const tbody = document.getElementById('leaderboardBody');
        tbody.innerHTML = '';
        leaderboard.forEach((player, idx) => {
            const progressPercent = Math.round((player.progress || 0) / totalQuestions * 100);
            const isMe = player.name === playerName;
            const rowClass = isMe ? 'table-primary fw-bold' : '';
            const tr = document.createElement('tr');
            tr.className = rowClass;
            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td>${player.name} ${isMe ? '<i class=\'fas fa-user\'></i>' : ''}</td>
                <td>${player.score || 0}</td>
                <td>${player.finished ? (player.time || 0).toFixed(1) : '-'}</td>
                <td>
                    ${player.finished ? '<span class=\'badge bg-success\'>انتهى</span>' :
                    gameStarted ? `<div class=\'progress\' style=\'height:12px; min-width:60px;\'>
                            <div class=\'progress-bar bg-info\' role=\'progressbar\' style=\'width:${progressPercent}%;\'>${progressPercent}%</div>
                        </div>` : '<span class=\'badge bg-warning\'>في الانتظار</span>'}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Exam logic integration
    function finishExam() {
        // Submit exam to server via Socket.IO
        const codeToSend = roomCode || localStorage.getItem('room_code');
        socket.emit('submit_answers', { room_code: codeToSend, answers: userAnswers, client_id: clientId });
    }

    // Show leaderboard after submit
    socket.on('leaderboard_update', function (data) {
        updateLeaderboard(data.leaderboard);
        // If this player finished, show results modal
        const me = data.leaderboard.find(p => p.name === playerName);
        if (me && me.finished) {
            showResults({
                correct_answers: me.score,
                total_questions: totalQuestions,
                score_percentage: (me.score / totalQuestions) * 100
            });
        }
    });

    // Hide exam UI until multiplayer game starts
    examContainer.style.display = 'none';
    leaderboardSection.style.display = 'none';

    // Global variables
    let currentQuestionIndex = 0;
    let questions = [];
    let userAnswers = {};
    let totalQuestions = 0;
    let incorrectAnswers = [];
    let randomizeQuestions = true;

    // Initialize the exam
    document.addEventListener('DOMContentLoaded', function () {
        // Load server data
        try {
            const serverData = JSON.parse(document.getElementById('serverData').textContent);
            questions = serverData.questions;
            totalQuestions = serverData.totalQuestions;
            randomizeQuestions = serverData.randomizeQuestions;
        } catch (e) {
            console.error('Error loading server data:', e);
        }

        loadQuestions();
        showQuestion(0);
        updateProgress();
        generateQuestionList();
        updateNavigationButtons();
        setupRandomizationControls();
        updateRandomizationStatus();

        // Prevent zoom on double tap for mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    });

    function setupRandomizationControls() {
        const randomizeToggle = document.getElementById('randomizeToggle');

        randomizeToggle.addEventListener('click', function () {
            randomizeQuestions = !randomizeQuestions;
            updateRandomizationSettings();
            updateRandomizationStatus();
        });
    }

    function updateRandomizationStatus() {
        const randomizeToggle = document.getElementById('randomizeToggle');
        if (randomizeQuestions) {
            randomizeToggle.classList.add('active');
            randomizeToggle.classList.remove('inactive');
        } else {
            randomizeToggle.classList.add('inactive');
            randomizeToggle.classList.remove('active');
        }
    }

    function updateRandomizationSettings() {
        fetch('/update_randomization', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                randomize_questions: randomizeQuestions
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    showRandomizationFeedback();

                    // Reload questions with new settings
                    reloadQuestionsWithNewSettings();
                }
            })
            .catch(error => {
                console.error('Error updating randomization settings:', error);
            });
    }

    function reloadQuestionsWithNewSettings() {
        // Store current question index and answers
        const currentIndex = currentQuestionIndex;
        const savedAnswers = { ...userAnswers };

        // Get updated questions data from server
        fetch('/get_questions_data')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }

                // Update global variables
                questions = data.questions;
                totalQuestions = data.total_questions;
                randomizeQuestions = data.randomize_questions;

                // Reload questions in the container
                loadQuestions();

                // Restore current question and answers
                currentQuestionIndex = currentIndex;
                userAnswers = savedAnswers;

                // Show the current question with restored state
                showQuestion(currentIndex);

                // Update question list
                generateQuestionList();

                // Update progress
                updateProgress();

                // Show success message
                showRandomizationFeedback();
            })
            .catch(error => {
                console.error('Error reloading questions:', error);
                // Fallback: reload the page
                window.location.reload();
            });
    }

    function showRandomizationFeedback() {
        // Create a temporary success message
        const feedback = document.createElement('div');
        feedback.className = 'alert alert-success alert-dismissible fade show position-fixed';
        feedback.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        feedback.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        تم تحديث إعدادات الامتحان بنجاح
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(feedback);

        // Remove after 3 seconds
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 3000);
    }

    function loadQuestions() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-slide';
            questionDiv.style.display = index === 0 ? 'block' : 'none';
            questionDiv.innerHTML = `
        <div class="question-text">
            ${question.text}
        </div>
        
        <div class="options-container">
            ${question.options.map((option, optionIndex) => `
                <div class="option-item" data-question="${index}" data-option="${optionIndex}" data-correct="${question.correct_answer}">
                    <div class="form-check w-100">
                        <input class="form-check-input" type="radio" 
                               name="answer_${index}" id="option_${index}_${optionIndex}" 
                               value="${optionIndex}">
                        <label class="form-check-label" for="option_${index}_${optionIndex}">
                            ${option}
                        </label>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
            container.appendChild(questionDiv);
        });

        // Add event listeners to options
        addOptionEventListeners();
    }

    function addOptionEventListeners() {
        const options = document.querySelectorAll('.option-item');
        options.forEach(option => {
            option.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                const questionIndex = parseInt(this.dataset.question);
                const optionIndex = parseInt(this.dataset.option);
                const correctAnswer = parseInt(this.dataset.correct);

                // Store the answer
                userAnswers[questionIndex] = optionIndex;

                // Show feedback
                showAnswerFeedback(questionIndex, optionIndex, correctAnswer);

                // Update navigation buttons
                updateNavigationButtons();

                // Show next button instead of auto-advancing
                showNextButton();
            });

            // Add touch event listeners for better mobile experience
            option.addEventListener('touchstart', function () {
                this.style.transform = 'scale(0.98)';
            });

            option.addEventListener('touchend', function () {
                this.style.transform = '';
            });
        });
    }

    function showAnswerFeedback(questionIndex, selectedAnswer, correctAnswer) {
        const questionDiv = document.querySelector(`[data-question="${questionIndex}"]`).parentElement;
        const options = questionDiv.querySelectorAll('.option-item');

        // Remove previous feedback
        options.forEach(opt => {
            opt.classList.remove('correct', 'incorrect');
        });

        // Show feedback
        if (selectedAnswer === correctAnswer) {
            options[selectedAnswer].classList.add('correct');

            // Add celebration animation
            setTimeout(() => {
                options[selectedAnswer].style.animation = 'correctPulse 0.6s ease-in-out';
            }, 100);
        } else {
            options[selectedAnswer].classList.add('incorrect');
            options[correctAnswer].classList.add('correct');

            // Store incorrect answer for review
            incorrectAnswers.push({
                questionIndex: questionIndex,
                question: questions[questionIndex],
                userAnswer: selectedAnswer,
                correctAnswer: correctAnswer
            });

            // Add shake animation
            setTimeout(() => {
                options[selectedAnswer].style.animation = 'incorrectShake 0.6s ease-in-out';
            }, 100);
        }

        // Disable further interaction
        options.forEach(opt => {
            opt.style.pointerEvents = 'none';
        });
    }

    function showQuestion(index) {
        const slides = document.querySelectorAll('.question-slide');
        slides.forEach((slide, i) => {
            slide.style.display = i === index ? 'block' : 'none';
        });

        document.getElementById('questionNumber').textContent = index + 1;
        currentQuestionIndex = index;

        updateNavigationButtons();
        updateProgress();

        // Show previous answers if they exist
        if (userAnswers[index] !== undefined) {
            const question = questions[index];
            showAnswerFeedback(index, userAnswers[index], question.correct_answer);
            showNextButton(); // Show next button if question was already answered
        } else {
            hideNextButton(); // Hide next button for unanswered questions
        }

        // Emit progress update for multiplayer
        if (multiplayerMode && roomCode) {
            socket.emit('progress_update', { room_code: roomCode, current_index: index, client_id: clientId });
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < totalQuestions - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    }

    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    }

    function showNextButton() {
        const nextBtn = document.getElementById('nextBtn');
        const finishBtn = document.getElementById('finishBtn');

        if (currentQuestionIndex === totalQuestions - 1) {
            // Last question - show finish button
            nextBtn.style.display = 'none';
            finishBtn.style.display = 'inline-block';
        } else {
            // Not last question - show next button
            nextBtn.style.display = 'inline-block';
            finishBtn.style.display = 'none';
        }
    }

    function hideNextButton() {
        const nextBtn = document.getElementById('nextBtn');
        const finishBtn = document.getElementById('finishBtn');

        nextBtn.style.display = 'none';
        finishBtn.style.display = 'none';
    }

    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevBtn');

        // Enable/disable previous button
        prevBtn.disabled = currentQuestionIndex === 0;
    }

    function updateProgress() {
        const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    function generateQuestionList() {
        const container = document.getElementById('questionList');
        container.innerHTML = '';

        questions.forEach((question, index) => {
            const questionBtn = document.createElement('div');
            questionBtn.className = 'col-6 col-md-3 mb-2';
            questionBtn.innerHTML = `
        <button class="btn btn-outline-primary w-100 question-nav-btn" 
                onclick="goToQuestion(${index})" 
                data-question="${index}">
            ${index + 1}
        </button>
    `;
            container.appendChild(questionBtn);
        });
    }

    function goToQuestion(index) {
        showQuestion(index);
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('questionListModal'));
        modal.hide();
    }

    function showQuestionList() {
        const modal = new bootstrap.Modal(document.getElementById('questionListModal'));
        modal.show();
    }

    function showResults(data) {
        document.getElementById('finalScore').textContent = data.score_percentage.toFixed(1) + '%';
        document.getElementById('correctCount').textContent = data.correct_answers;
        document.getElementById('incorrectCount').textContent = data.total_questions - data.correct_answers;
        document.getElementById('finalProgressBar').style.width = data.score_percentage + '%';

        // Performance message
        let message = '';
        if (data.score_percentage >= 90) {
            message = '<strong>ممتاز!</strong> أداء رائع، احتفظ بهذا المستوى.';
        } else if (data.score_percentage >= 80) {
            message = '<strong>جيد جداً!</strong> أداء ممتاز، واصل التقدم.';
        } else if (data.score_percentage >= 70) {
            message = '<strong>جيد!</strong> أداء مقبول، يمكنك التحسن أكثر.';
        } else if (data.score_percentage >= 60) {
            message = '<strong>مقبول!</strong> تحتاج إلى مراجعة أكثر.';
        } else {
            message = '<strong>تحتاج إلى تحسين!</strong> راجع المادة جيداً وحاول مرة أخرى.';
        }
        document.getElementById('performanceMessage').innerHTML = message;

        // Show review section if there are incorrect answers
        if (incorrectAnswers.length > 0) {
            document.getElementById('reviewSection').style.display = 'block';
            generateReviewContent();
        }

        const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
        modal.show();
    }

    function generateReviewContent() {
        const container = document.getElementById('reviewQuestions');
        container.innerHTML = '';

        incorrectAnswers.forEach((item, index) => {
            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'review-question';
            reviewDiv.innerHTML = `
            <h6 class="mb-2">
                <i class="fas fa-question-circle me-2"></i>
                السؤال ${item.questionIndex + 1}:
            </h6>
            <p class="mb-3">${item.question.text}</p>
            
            <div class="options-review">
                ${item.question.options.map((option, optionIndex) => {
                let className = 'review-option';
                if (optionIndex === item.userAnswer) {
                    className += ' user-answer';
                }
                if (optionIndex === item.correctAnswer) {
                    className += ' correct-answer';
                }

                return `
                    <div class="${className}">
                        <i class="fas ${optionIndex === item.correctAnswer ? 'fa-check text-success' :
                        optionIndex === item.userAnswer ? 'fa-times text-danger' : 'fa-circle text-muted'} me-2"></i>
                        ${option}
                    </div>
                `;
            }).join('')}
            </div>
        `;
            container.appendChild(reviewDiv);
        });
    }

    function toggleReview() {
        const content = document.getElementById('reviewContent');
        const isVisible = content.style.display !== 'none';

        if (isVisible) {
            content.style.display = 'none';
            content.style.animation = 'slideInUp 0.3s ease-in-out reverse';
        } else {
            content.style.display = 'block';
            content.style.animation = 'slideInUp 0.3s ease-in-out';
        }
    }

    function closeResultsModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
        modal.hide();
    }

    // Keyboard navigation
    document.addEventListener('keydown', function (e) {
        if (e.key >= '1' && e.key <= '3') {
            const currentQuestion = questions[currentQuestionIndex];
            const optionIndex = parseInt(e.key) - 1;
            if (optionIndex < currentQuestion.options.length) {
                const optionElement = document.querySelector(`[data-question="${currentQuestionIndex}"][data-option="${optionIndex}"]`);
                if (optionElement) {
                    optionElement.click();
                }
            }
        } else if (e.key === 'ArrowRight') {
            previousQuestion();
        }
    });

    // Swipe navigation for mobile
    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });

    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // Swipe left - go to next question
                if (currentQuestionIndex < totalQuestions - 1) {
                    nextQuestion();
                }
            } else {
                // Swipe right - go to previous question
                if (currentQuestionIndex > 0) {
                    previousQuestion();
                }
            }
        }
    }
</script>
{% endblock %}