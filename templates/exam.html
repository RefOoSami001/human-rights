{% extends "base.html" %}

{% block title %}الامتحان - امتحان حقوق الإنسان{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12">
        <!-- Progress Bar -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 progress-text">التقدم في الامتحان</h6>
                    <span id="progressText" class="progress-text">1 من {{ total_questions }}</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 1%">
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Container -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            <i class="fas fa-question-circle me-2"></i>
                            السؤال <span id="questionNumber">1</span> من {{ total_questions }}
                        </h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-light btn-sm" onclick="showQuestionList()">
                            <i class="fas fa-list me-1"></i>
                            <span class="d-none d-sm-inline">قائمة الأسئلة</span>
                            <span class="d-sm-none">القائمة</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-4">
                <!-- Questions will be loaded here -->
                <div id="questionsContainer">
                    <!-- Questions will be dynamically inserted here -->
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <button class="btn btn-secondary flex-fill me-2" id="prevBtn" onclick="previousQuestion()">
                        <i class="fas fa-arrow-right me-2"></i>
                        السابق
                    </button>

                    <div class="d-flex gap-2 flex-fill">
                        <button class="btn btn-primary flex-fill" id="nextBtn" onclick="nextQuestion()"
                            style="display: none;">
                            <i class="fas fa-arrow-left me-2"></i>
                            التالي
                        </button>

                        <button class="btn btn-success flex-fill" id="finishBtn" onclick="finishExam()"
                            style="display: none;">
                            <i class="fas fa-check me-2"></i>
                            إنهاء الامتحان
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Question List Modal -->
<div class="modal fade" id="questionListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">قائمة الأسئلة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="questionList">
                    <!-- Question list will be generated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trophy me-2"></i>
                    نتيجة الامتحان
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="score-display mb-4" id="finalScore">0%</div>

                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="text-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    الإجابات الصحيحة
                                </h5>
                                <h2 class="text-success" id="correctCount">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="text-danger">
                                    <i class="fas fa-times-circle me-2"></i>
                                    الإجابات الخاطئة
                                </h5>
                                <h2 class="text-danger" id="incorrectCount">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="progress mb-4" style="height: 20px;">
                    <div class="progress-bar bg-success" id="finalProgressBar" role="progressbar" style="width: 0%">
                    </div>
                </div>

                <div class="alert alert-info" id="performanceMessage">
                    <!-- Performance message will be inserted here -->
                </div>

                <!-- Review Section -->
                <div id="reviewSection" style="display: none;">
                    <div class="review-section" onclick="toggleReview()">
                        <h5 class="mb-2">
                            <i class="fas fa-eye me-2"></i>
                            مراجعة الإجابات الخاطئة
                        </h5>
                        <p class="mb-0">اضغط هنا لمراجعة الأسئلة التي أجبت عليها خطأ</p>
                    </div>

                    <div id="reviewContent" style="display: none;">
                        <div class="text-start">
                            <h6 class="mb-3 text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                الأسئلة الخاطئة:
                            </h6>
                            <div id="reviewQuestions">
                                <!-- Review questions will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex-column flex-sm-row">
                <a href="{{ url_for('restart') }}" class="btn btn-primary mb-2 mb-sm-0">
                    <i class="fas fa-redo me-2"></i>
                    إعادة الامتحان
                </a>
                <button type="button" class="btn btn-secondary" onclick="closeResultsModal()">
                    <i class="fas fa-times me-2"></i>
                    إغلاق
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let currentQuestionIndex = 0;
    let questions = {{ questions | tojson | safe }};
    let userAnswers = {};
    let totalQuestions = {{ total_questions }};
    let incorrectAnswers = [];

    // Initialize the exam
    document.addEventListener('DOMContentLoaded', function () {
        loadQuestions();
        showQuestion(0);
        updateProgress();
        generateQuestionList();
        updateNavigationButtons();

        // Prevent zoom on double tap for mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    });

    function loadQuestions() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-slide';
            questionDiv.style.display = index === 0 ? 'block' : 'none';
            questionDiv.innerHTML = `
            <div class="question-text">
                ${question.text}
            </div>
            
            <div class="options-container">
                ${question.options.map((option, optionIndex) => `
                    <div class="option-item" data-question="${index}" data-option="${optionIndex}" data-correct="${question.correct_answer}">
                        <div class="form-check w-100">
                            <input class="form-check-input" type="radio" 
                                   name="answer_${index}" id="option_${index}_${optionIndex}" 
                                   value="${optionIndex}">
                            <label class="form-check-label" for="option_${index}_${optionIndex}">
                                ${option}
                            </label>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
            container.appendChild(questionDiv);
        });

        // Add event listeners to options
        addOptionEventListeners();
    }

    function addOptionEventListeners() {
        const options = document.querySelectorAll('.option-item');
        options.forEach(option => {
            option.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                const questionIndex = parseInt(this.dataset.question);
                const optionIndex = parseInt(this.dataset.option);
                const correctAnswer = parseInt(this.dataset.correct);

                // Store the answer
                userAnswers[questionIndex] = optionIndex;

                // Show feedback with sound
                showAnswerFeedback(questionIndex, optionIndex, correctAnswer);

                // Update navigation buttons
                updateNavigationButtons();

                // Show next button instead of auto-advancing
                showNextButton();
            });

            // Add touch event listeners for better mobile experience
            option.addEventListener('touchstart', function () {
                this.style.transform = 'scale(0.98)';
            });

            option.addEventListener('touchend', function () {
                this.style.transform = '';
            });
        });
    }

    function showAnswerFeedback(questionIndex, selectedAnswer, correctAnswer) {
        const questionDiv = document.querySelector(`[data-question="${questionIndex}"]`).parentElement;
        const options = questionDiv.querySelectorAll('.option-item');

        // Remove previous feedback
        options.forEach(opt => {
            opt.classList.remove('correct', 'incorrect');
        });

        // Show feedback and play sound
        if (selectedAnswer === correctAnswer) {
            options[selectedAnswer].classList.add('correct');

            // Play sound with error handling
            try {
                if (typeof window.playSound === 'function') {
                    window.playSound('correctSound');
                }
            } catch (e) {
                console.log('Sound play failed:', e);
            }

            // Add celebration animation
            setTimeout(() => {
                options[selectedAnswer].style.animation = 'correctPulse 0.6s ease-in-out';
            }, 100);
        } else {
            options[selectedAnswer].classList.add('incorrect');
            options[correctAnswer].classList.add('correct');

            // Play sound with error handling
            try {
                if (typeof window.playSound === 'function') {
                    window.playSound('incorrectSound');
                }
            } catch (e) {
                console.log('Sound play failed:', e);
            }

            // Store incorrect answer for review
            incorrectAnswers.push({
                questionIndex: questionIndex,
                question: questions[questionIndex],
                userAnswer: selectedAnswer,
                correctAnswer: correctAnswer
            });

            // Add shake animation
            setTimeout(() => {
                options[selectedAnswer].style.animation = 'incorrectShake 0.6s ease-in-out';
            }, 100);
        }

        // Disable further interaction
        options.forEach(opt => {
            opt.style.pointerEvents = 'none';
        });
    }

    function showQuestion(index) {
        const slides = document.querySelectorAll('.question-slide');
        slides.forEach((slide, i) => {
            slide.style.display = i === index ? 'block' : 'none';
        });

        document.getElementById('questionNumber').textContent = index + 1;
        currentQuestionIndex = index;

        updateNavigationButtons();
        updateProgress();

        // Show previous answers if they exist
        if (userAnswers[index] !== undefined) {
            const question = questions[index];
            showAnswerFeedback(index, userAnswers[index], question.correct_answer);
            showNextButton(); // Show next button if question was already answered
        } else {
            hideNextButton(); // Hide next button for unanswered questions
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < totalQuestions - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    }

    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    }

    function showNextButton() {
        const nextBtn = document.getElementById('nextBtn');
        const finishBtn = document.getElementById('finishBtn');

        if (currentQuestionIndex === totalQuestions - 1) {
            // Last question - show finish button
            nextBtn.style.display = 'none';
            finishBtn.style.display = 'inline-block';
        } else {
            // Not last question - show next button
            nextBtn.style.display = 'inline-block';
            finishBtn.style.display = 'none';
        }
    }

    function hideNextButton() {
        const nextBtn = document.getElementById('nextBtn');
        const finishBtn = document.getElementById('finishBtn');

        nextBtn.style.display = 'none';
        finishBtn.style.display = 'none';
    }

    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevBtn');

        // Enable/disable previous button
        prevBtn.disabled = currentQuestionIndex === 0;
    }

    function updateProgress() {
        const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${currentQuestionIndex + 1} من ${totalQuestions}`;
    }

    function generateQuestionList() {
        const container = document.getElementById('questionList');
        container.innerHTML = '';

        questions.forEach((question, index) => {
            const questionBtn = document.createElement('div');
            questionBtn.className = 'col-6 col-md-3 mb-2';
            questionBtn.innerHTML = `
            <button class="btn btn-outline-primary w-100 question-nav-btn" 
                    onclick="goToQuestion(${index})" 
                    data-question="${index}">
                ${index + 1}
            </button>
        `;
            container.appendChild(questionBtn);
        });
    }

    function goToQuestion(index) {
        showQuestion(index);
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('questionListModal'));
        modal.hide();
    }

    function showQuestionList() {
        const modal = new bootstrap.Modal(document.getElementById('questionListModal'));
        modal.show();
    }

    function finishExam() {
        // Submit exam to server
        fetch('/submit_exam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                answers: userAnswers
            })
        })
            .then(response => response.json())
            .then(data => {
                // Play completion sound with error handling
                try {
                    if (typeof window.playSound === 'function') {
                        window.playSound('completeSound');
                    }
                } catch (e) {
                    console.log('Completion sound failed:', e);
                }

                showResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('حدث خطأ في إرسال النتيجة');
            });
    }

    function showResults(data) {
        document.getElementById('finalScore').textContent = data.score_percentage.toFixed(1) + '%';
        document.getElementById('correctCount').textContent = data.correct_answers;
        document.getElementById('incorrectCount').textContent = data.total_questions - data.correct_answers;
        document.getElementById('finalProgressBar').style.width = data.score_percentage + '%';

        // Performance message
        let message = '';
        if (data.score_percentage >= 90) {
            message = '<strong>ممتاز!</strong> أداء رائع، احتفظ بهذا المستوى.';
        } else if (data.score_percentage >= 80) {
            message = '<strong>جيد جداً!</strong> أداء ممتاز، واصل التقدم.';
        } else if (data.score_percentage >= 70) {
            message = '<strong>جيد!</strong> أداء مقبول، يمكنك التحسن أكثر.';
        } else if (data.score_percentage >= 60) {
            message = '<strong>مقبول!</strong> تحتاج إلى مراجعة أكثر.';
        } else {
            message = '<strong>تحتاج إلى تحسين!</strong> راجع المادة جيداً وحاول مرة أخرى.';
        }
        document.getElementById('performanceMessage').innerHTML = message;

        // Show review section if there are incorrect answers
        if (incorrectAnswers.length > 0) {
            document.getElementById('reviewSection').style.display = 'block';
            generateReviewContent();
        }

        const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
        modal.show();
    }

    function generateReviewContent() {
        const container = document.getElementById('reviewQuestions');
        container.innerHTML = '';

        incorrectAnswers.forEach((item, index) => {
            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'review-question';
            reviewDiv.innerHTML = `
                <h6 class="mb-2">
                    <i class="fas fa-question-circle me-2"></i>
                    السؤال ${item.questionIndex + 1}:
                </h6>
                <p class="mb-3">${item.question.text}</p>
                
                <div class="options-review">
                    ${item.question.options.map((option, optionIndex) => {
                let className = 'review-option';
                if (optionIndex === item.userAnswer) {
                    className += ' user-answer';
                }
                if (optionIndex === item.correctAnswer) {
                    className += ' correct-answer';
                }

                return `
                            <div class="${className}">
                                <i class="fas ${optionIndex === item.correctAnswer ? 'fa-check text-success' :
                        optionIndex === item.userAnswer ? 'fa-times text-danger' : 'fa-circle text-muted'} me-2"></i>
                                ${option}
                            </div>
                        `;
            }).join('')}
                </div>
            `;
            container.appendChild(reviewDiv);
        });
    }

    function toggleReview() {
        const content = document.getElementById('reviewContent');
        const isVisible = content.style.display !== 'none';

        if (isVisible) {
            content.style.display = 'none';
            content.style.animation = 'slideInUp 0.3s ease-in-out reverse';
        } else {
            content.style.display = 'block';
            content.style.animation = 'slideInUp 0.3s ease-in-out';
        }
    }

    function closeResultsModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
        modal.hide();
    }

    // Keyboard navigation
    document.addEventListener('keydown', function (e) {
        if (e.key >= '1' && e.key <= '3') {
            const currentQuestion = questions[currentQuestionIndex];
            const optionIndex = parseInt(e.key) - 1;
            if (optionIndex < currentQuestion.options.length) {
                const optionElement = document.querySelector(`[data-question="${currentQuestionIndex}"][data-option="${optionIndex}"]`);
                if (optionElement) {
                    optionElement.click();
                }
            }
        } else if (e.key === 'ArrowRight') {
            previousQuestion();
        }
    });

    // Swipe navigation for mobile
    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });

    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // Swipe left - go to next question
                if (currentQuestionIndex < totalQuestions - 1) {
                    nextQuestion();
                }
            } else {
                // Swipe right - go to previous question
                if (currentQuestionIndex > 0) {
                    previousQuestion();
                }
            }
        }
    }
</script>
{% endblock %}